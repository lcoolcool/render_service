# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> æ¸²æŸ“æœåŠ¡æ•°æ®åº“ Schema è®¾è®¡
> ç‰ˆæœ¬: v2.0
> æ›´æ–°æ—¥æœŸ: 2025-11-04
> ORM: Tortoise ORM
> æ•°æ®åº“: SQLite (å¯è¿ç§»åˆ° PostgreSQL/MySQL)

---

## 1. è®¾è®¡åŸåˆ™

### 1.1 æ ¸å¿ƒåŸåˆ™

âœ… **å‘åå…¼å®¹** - ä¿ç•™ç°æœ‰è¡¨ç»“æ„,åªæ·»åŠ æ–°å­—æ®µ
âœ… **æœ€å°ç ´å** - æ–°åŠŸèƒ½ä½¿ç”¨æ–°è¡¨,ä¸ä¿®æ”¹ç°æœ‰æ•°æ®
âœ… **æ¸è¿›å¼è¿ç§»** - åˆ†é˜¶æ®µæ·»åŠ å­—æ®µå’Œè¡¨
âœ… **æ€§èƒ½ä¼˜å…ˆ** - åˆç†è®¾è®¡ç´¢å¼•,ä¼˜åŒ–æŸ¥è¯¢
âœ… **æ•°æ®å®Œæ•´æ€§** - å¤–é”®çº¦æŸ,é˜²æ­¢è„æ•°æ®

### 1.2 å‘½åè§„èŒƒ

- **è¡¨å**: å°å†™ + ä¸‹åˆ’çº¿ (å¦‚ `render_tasks`, `render_frames`)
- **å­—æ®µå**: å°å†™ + ä¸‹åˆ’çº¿ (å¦‚ `created_at`, `file_hash`)
- **æšä¸¾**: å¤§å†™ + ä¸‹åˆ’çº¿ (å¦‚ `TaskStatus.COMPLETED`)
- **ç´¢å¼•**: `idx_{è¡¨å}_{å­—æ®µå}` (å¦‚ `idx_tasks_user_id`)

---

## 2. è¡¨ç»“æ„è®¾è®¡

### 2.1 ç°æœ‰è¡¨ (æ‰©å±•)

#### ğŸ“‹ RenderTask (app/models/task.py)

**ç°æœ‰å­—æ®µ**:
```python
class RenderTask(Model):
    id = IntField(pk=True)
    unionid = CharField(max_length=100)         # ç”¨æˆ·ID
    oss_file_path = CharField(max_length=500)   # OSSæ–‡ä»¶è·¯å¾„
    is_compressed = BooleanField(default=False)
    project_file = CharField(max_length=500, null=True)
    workspace_dir = CharField(max_length=500, null=True)
    render_engine = CharEnumField(RenderEngine)
    status = CharEnumField(TaskStatus)
    priority = IntField(default=5)
    celery_task_id = CharField(max_length=100, null=True)
    task_info = JSONField(default=dict)
    total_frames = IntField(default=1)
    created_at = DatetimeField(auto_now_add=True)
    updated_at = DatetimeField(auto_now=True)
    completed_at = DatetimeField(null=True)
    error_message = TextField(null=True)
```

**æ–°å¢å­—æ®µ** (æ‰©å±•):

```python
class RenderTask(Model):
    # ... ç°æœ‰å­—æ®µ ...

    # === åœºæ™¯ä¿¡æ¯ ===
    scene_file_hash = CharField(max_length=64, null=True)
    # MD5 å“ˆå¸Œå€¼,ç”¨äºå¢é‡ä¸Šä¼ 

    scene_file_size = BigIntField(null=True)
    # åœºæ™¯æ–‡ä»¶å¤§å° (å­—èŠ‚)

    # === æµ‹è¯•å¸§é…ç½® ===
    test_frames = CharField(max_length=100, null=True)
    # æµ‹è¯•å¸§å·,å¦‚ "50" æˆ– "10,20,30"

    stop_after_test = BooleanField(default=False)
    # æµ‹è¯•å¸§å¤±è´¥åæ˜¯å¦åœæ­¢

    # === ç¡¬ä»¶éœ€æ±‚ ===
    ram = IntField(null=True)
    # æ‰€éœ€å†…å­˜ (GB)

    gpu_count = IntField(default=0)
    # æ‰€éœ€ GPU æ•°é‡

    hardware_config_id = CharField(max_length=20, null=True)
    # ç¡¬ä»¶é…ç½®ID (å¤–é”®åˆ° HardwareConfig)

    # === è¶…æ—¶æ§åˆ¶ ===
    frame_timeout = IntField(default=43200)
    # å•å¸§è¶…æ—¶æ—¶é—´ (ç§’),é»˜è®¤ 12 å°æ—¶

    task_timeout = IntField(default=86400)
    # ä»»åŠ¡æ€»è¶…æ—¶ (ç§’),é»˜è®¤ 24 å°æ—¶

    # === CG è½¯ä»¶ä¿¡æ¯ ===
    cg_id = IntField(null=True)
    # CG è½¯ä»¶ID: 2000=Maya, 2001=3ds Max

    cg_version = CharField(max_length=20, null=True)
    # CG è½¯ä»¶ç‰ˆæœ¬: "2024"

    renderer = CharField(max_length=50, null=True)
    # æ¸²æŸ“å™¨åç§°: "arnold", "vray"

    plugins = JSONField(null=True)
    # æ’ä»¶ç‰ˆæœ¬ä¿¡æ¯: {"mtoa": "5.5.1"}

    # === è¿›åº¦è¿½è¸ª ===
    progress = DecimalField(max_digits=5, decimal_places=2, default=0)
    # æ¸²æŸ“è¿›åº¦ç™¾åˆ†æ¯” (0.00 - 100.00)

    completed_frames_count = IntField(default=0)
    # å·²å®Œæˆå¸§æ•°

    failed_frames_count = IntField(default=0)
    # å¤±è´¥å¸§æ•°

    # === æˆæœ¬ç»Ÿè®¡ ===
    estimated_cost = DecimalField(max_digits=10, decimal_places=2, null=True)
    # é¢„ä¼°æˆæœ¬

    actual_cost = DecimalField(max_digits=10, decimal_places=2, null=True)
    # å®é™…æˆæœ¬
```

**è¿ç§»ç­–ç•¥**:
1. ç¬¬ä¸€é˜¶æ®µ: æ·»åŠ æµ‹è¯•å¸§å­—æ®µ (`test_frames`, `stop_after_test`)
2. ç¬¬äºŒé˜¶æ®µ: æ·»åŠ ç¡¬ä»¶éœ€æ±‚å­—æ®µ (`ram`, `gpu_count`, `hardware_config_id`)
3. ç¬¬ä¸‰é˜¶æ®µ: æ·»åŠ æ–‡ä»¶å“ˆå¸Œå­—æ®µ (`scene_file_hash`, `scene_file_size`)
4. ç¬¬å››é˜¶æ®µ: æ·»åŠ å…¶ä»–æ‰©å±•å­—æ®µ

---

#### ğŸï¸ RenderFrame (app/models/frame.py)

**ç°æœ‰å­—æ®µ**:
```python
class RenderFrame(Model):
    id = IntField(pk=True)
    task = ForeignKeyField("models.RenderTask", related_name="frames")
    frame_number = IntField()
    status = CharEnumField(FrameStatus)
    output_path = CharField(max_length=500, null=True)
    created_at = DatetimeField(auto_now_add=True)
    started_at = DatetimeField(null=True)
    completed_at = DatetimeField(null=True)
    error_message = TextField(null=True)
```

**æ–°å¢å­—æ®µ** (æ‰©å±•):

```python
class RenderFrame(Model):
    # ... ç°æœ‰å­—æ®µ ...

    # === æ¸²æŸ“èŠ‚ç‚¹ä¿¡æ¯ ===
    node_id = CharField(max_length=50, null=True)
    # åˆ†é…çš„æ¸²æŸ“èŠ‚ç‚¹ID

    # === è¾“å‡ºæ–‡ä»¶ä¿¡æ¯ ===
    output_size = BigIntField(null=True)
    # è¾“å‡ºæ–‡ä»¶å¤§å° (å­—èŠ‚)

    output_hash = CharField(max_length=64, null=True)
    # è¾“å‡ºæ–‡ä»¶ MD5 å“ˆå¸Œ

    # === æ€§èƒ½ç»Ÿè®¡ ===
    render_time = IntField(null=True)
    # å®é™…æ¸²æŸ“æ—¶é—´ (ç§’)

    retry_count = IntField(default=0)
    # é‡è¯•æ¬¡æ•°

    # === æ˜¯å¦æµ‹è¯•å¸§ ===
    is_test_frame = BooleanField(default=False)
    # æ ‡è®°æ˜¯å¦ä¸ºæµ‹è¯•å¸§
```

---

### 2.2 æ–°å¢è¡¨

#### ğŸ‘¤ User (app/models/user.py)

**ç”¨é€”**: ç”¨æˆ·ç®¡ç†å’Œæƒé™æ§åˆ¶

```python
from tortoise import Model, fields
from enum import Enum

class AccountType(str, Enum):
    PERSONAL = "personal"    # ä¸ªäººè´¦æˆ·
    ENTERPRISE = "enterprise"  # ä¼ä¸šè´¦æˆ·

class User(Model):
    """ç”¨æˆ·è¡¨"""

    id = fields.BigIntField(pk=True)
    # ç”¨æˆ·ID (å¯èƒ½ä»å¤–éƒ¨ç³»ç»ŸåŒæ­¥)

    unionid = fields.CharField(max_length=100, unique=True)
    # ç»Ÿä¸€ç”¨æˆ·æ ‡è¯† (ç”¨äºæ–‡ä»¶éš”ç¦»)

    username = fields.CharField(max_length=100)
    # ç”¨æˆ·å

    email = fields.CharField(max_length=255, null=True)
    # é‚®ç®±

    account_type = fields.CharEnumField(AccountType, default=AccountType.PERSONAL)
    # è´¦æˆ·ç±»å‹

    parent_id = fields.BigIntField(null=True)
    # ä¸»è´¦æˆ·ID (å­è´¦æˆ·ä½¿ç”¨)

    share_main_capital = fields.BooleanField(default=False)
    # æ˜¯å¦å…±äº«ä¸»è´¦æˆ·ä½™é¢

    balance = fields.DecimalField(max_digits=10, decimal_places=2, default=0)
    # è´¦æˆ·ä½™é¢

    is_active = fields.BooleanField(default=True)
    # æ˜¯å¦æ¿€æ´»

    created_at = fields.DatetimeField(auto_now_add=True)
    updated_at = fields.DatetimeField(auto_now=True)

    class Meta:
        table = "users"
        indexes = [
            ("unionid",),
            ("parent_id",),
        ]
```

---

#### ğŸ“¦ Asset (app/models/asset.py)

**ç”¨é€”**: æ–‡ä»¶èµ„äº§ç®¡ç†å’Œå»é‡

```python
from tortoise import Model, fields
from enum import Enum

class AssetType(str, Enum):
    TEXTURE = "texture"         # è´´å›¾
    SCENE = "scene"             # åœºæ™¯æ–‡ä»¶
    PLUGIN = "plugin"           # æ’ä»¶æ–‡ä»¶
    CACHE = "cache"             # ç¼“å­˜æ–‡ä»¶
    XGEN = "xgen"               # XGen æ¯›å‘
    OTHER = "other"             # å…¶ä»–

class Asset(Model):
    """èµ„äº§æ–‡ä»¶è¡¨ (ç”¨äºå»é‡å’Œç®¡ç†)"""

    id = fields.BigIntField(pk=True)

    file_path = fields.CharField(max_length=500)
    # åŸå§‹æ–‡ä»¶è·¯å¾„ (å®¢æˆ·ç«¯è·¯å¾„)

    file_hash = fields.CharField(max_length=64, unique=True)
    # MD5 å“ˆå¸Œå€¼ (ç”¨äºå»é‡)

    file_xxhash = fields.CharField(max_length=20, null=True)
    # xxHash (å¿«é€Ÿæ ¡éªŒ)

    file_size = fields.BigIntField()
    # æ–‡ä»¶å¤§å° (å­—èŠ‚)

    file_type = fields.CharEnumField(AssetType, default=AssetType.OTHER)
    # æ–‡ä»¶ç±»å‹

    storage_path = fields.CharField(max_length=500)
    # OSS å­˜å‚¨è·¯å¾„

    uploaded_by = fields.CharField(max_length=100, null=True)
    # ä¸Šä¼ ç”¨æˆ· (unionid)

    reference_count = fields.IntField(default=0)
    # è¢«å¼•ç”¨æ¬¡æ•° (ç”¨äºåƒåœ¾å›æ”¶)

    uploaded_at = fields.DatetimeField(auto_now_add=True)
    last_used_at = fields.DatetimeField(null=True)
    # æœ€åä½¿ç”¨æ—¶é—´

    class Meta:
        table = "assets"
        indexes = [
            ("file_hash",),
            ("file_xxhash",),
            ("uploaded_by", "uploaded_at"),
        ]
```

---

#### ğŸ”— TaskAsset (app/models/task_asset.py)

**ç”¨é€”**: ä»»åŠ¡ä¸èµ„äº§çš„å¤šå¯¹å¤šå…³è”

```python
from tortoise import Model, fields

class TaskAsset(Model):
    """ä»»åŠ¡-èµ„äº§å…³è”è¡¨"""

    id = fields.BigIntField(pk=True)

    task = fields.ForeignKeyField("models.RenderTask", related_name="task_assets")
    # ä»»åŠ¡ID

    asset = fields.ForeignKeyField("models.Asset", related_name="asset_tasks")
    # èµ„äº§ID

    local_path = fields.CharField(max_length=500)
    # å®¢æˆ·ç«¯æœ¬åœ°è·¯å¾„

    server_path = fields.CharField(max_length=500)
    # æœåŠ¡å™¨è·¯å¾„ (Windows: /C/...)

    is_missing = fields.BooleanField(default=False)
    # æ˜¯å¦ç¼ºå¤±

    created_at = fields.DatetimeField(auto_now_add=True)

    class Meta:
        table = "task_assets"
        indexes = [
            ("task_id",),
            ("asset_id",),
        ]
        unique_together = [("task_id", "asset_id")]
```

---

#### ğŸ–¥ï¸ HardwareConfig (app/models/hardware.py)

**ç”¨é€”**: ç¡¬ä»¶é…ç½®ç®¡ç†

```python
from tortoise import Model, fields

class HardwareConfig(Model):
    """ç¡¬ä»¶é…ç½®è¡¨"""

    id = fields.CharField(max_length=20, pk=True)
    # é…ç½®ID (å¦‚ "418")

    config_name = fields.CharField(max_length=100)
    # é…ç½®åç§° (å¦‚ "é«˜æ€§èƒ½æ¸²æŸ“èŠ‚ç‚¹")

    ram = fields.IntField()
    # å†…å­˜ (GB)

    cpu_cores = fields.IntField(null=True)
    # CPU æ ¸å¿ƒæ•°

    gpu_count = fields.IntField(default=0)
    # GPU æ•°é‡

    gpu_model = fields.CharField(max_length=100, null=True)
    # GPU å‹å· (å¦‚ "RTX 4090")

    price_per_hour = fields.DecimalField(max_digits=10, decimal_places=4, null=True)
    # å•ä»· (å…ƒ/å°æ—¶)

    is_available = fields.BooleanField(default=True)
    # æ˜¯å¦å¯ç”¨

    created_at = fields.DatetimeField(auto_now_add=True)

    class Meta:
        table = "hardware_configs"
```

**åˆå§‹æ•°æ®**:

```python
# é¢„ç½®ç¡¬ä»¶é…ç½®
HARDWARE_CONFIGS = [
    {
        "id": "basic",
        "config_name": "åŸºç¡€é…ç½®",
        "ram": 16,
        "cpu_cores": 8,
        "gpu_count": 0,
        "price_per_hour": 0.5
    },
    {
        "id": "standard",
        "config_name": "æ ‡å‡†é…ç½®",
        "ram": 32,
        "cpu_cores": 16,
        "gpu_count": 0,
        "price_per_hour": 1.0
    },
    {
        "id": "high_performance",
        "config_name": "é«˜æ€§èƒ½é…ç½®",
        "ram": 64,
        "cpu_cores": 24,
        "gpu_count": 2,
        "gpu_model": "RTX 4090",
        "price_per_hour": 2.5
    },
]
```

---

#### ğŸ“Š SceneAnalysis (app/models/scene_analysis.py)

**ç”¨é€”**: ç¼“å­˜åœºæ™¯åˆ†æç»“æœ

```python
from tortoise import Model, fields

class SceneAnalysis(Model):
    """åœºæ™¯åˆ†æç»“æœç¼“å­˜"""

    id = fields.BigIntField(pk=True)

    scene_file_path = fields.CharField(max_length=500)
    # åœºæ™¯æ–‡ä»¶è·¯å¾„

    scene_file_hash = fields.CharField(max_length=64, unique=True)
    # åœºæ™¯æ–‡ä»¶å“ˆå¸Œ (ç”¨äºç¼“å­˜åˆ¤æ–­)

    analysis_result = fields.JSONField()
    # åˆ†æç»“æœ (asset.json æ ¼å¼)
    # {
    #   "scene_info": {...},
    #   "asset": [...],
    #   "missing": [...]
    # }

    asset_count = fields.IntField(default=0)
    # èµ„äº§æ•°é‡

    missing_count = fields.IntField(default=0)
    # ç¼ºå¤±æ–‡ä»¶æ•°é‡

    analyzed_at = fields.DatetimeField(auto_now_add=True)
    # åˆ†ææ—¶é—´

    class Meta:
        table = "scene_analyses"
        indexes = [
            ("scene_file_hash",),
        ]
```

---

## 3. è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RenderTask  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  SceneAnalysis  â”‚
â”‚             â”‚ 1       1 â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1                (ç¼“å­˜,å¯é€‰å…³è”)
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RenderFrame â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RenderTask  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  TaskAsset  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚ 1       N â”‚             â”‚ N       1 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                                     â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
                          â”‚    Asset    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HardwareConfig  â”‚       â”‚ RenderTask  â”‚
â”‚                 â”‚ 1   N â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      (hardware_config_id)
```

---

## 4. ç´¢å¼•è®¾è®¡

### 4.1 æ€§èƒ½å…³é”®æŸ¥è¯¢

#### æŸ¥è¯¢ 1: è·å–ç”¨æˆ·çš„æ‰€æœ‰ä»»åŠ¡

```sql
SELECT * FROM render_tasks
WHERE unionid = 'user123'
ORDER BY created_at DESC
LIMIT 20;
```

**ç´¢å¼•**:
```python
# RenderTask
indexes = [
    ("unionid", "created_at"),  # å¤åˆç´¢å¼•
]
```

---

#### æŸ¥è¯¢ 2: è·å–ä»»åŠ¡çš„æ‰€æœ‰å¸§

```sql
SELECT * FROM render_frames
WHERE task_id = 123
ORDER BY frame_number ASC;
```

**ç´¢å¼•**:
```python
# RenderFrame
indexes = [
    ("task_id", "frame_number"),  # å¤åˆç´¢å¼•
]
```

---

#### æŸ¥è¯¢ 3: æŒ‰ä¼˜å…ˆçº§è·å–å¾…å¤„ç†ä»»åŠ¡

```sql
SELECT * FROM render_tasks
WHERE status = 'queued'
ORDER BY priority DESC, created_at ASC
LIMIT 10;
```

**ç´¢å¼•**:
```python
# RenderTask
indexes = [
    ("status", "priority", "created_at"),  # å¤åˆç´¢å¼•
]
```

---

#### æŸ¥è¯¢ 4: æ–‡ä»¶ hash å»é‡

```sql
SELECT * FROM assets
WHERE file_hash = '6e57efc1fb88700dfc4820e160348f07';
```

**ç´¢å¼•**:
```python
# Asset
file_hash = fields.CharField(max_length=64, unique=True)  # è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•
```

---

#### æŸ¥è¯¢ 5: è·å–ä»»åŠ¡çš„æ‰€æœ‰èµ„äº§

```sql
SELECT a.* FROM assets a
JOIN task_assets ta ON a.id = ta.asset_id
WHERE ta.task_id = 123;
```

**ç´¢å¼•**:
```python
# TaskAsset
indexes = [
    ("task_id",),
    ("asset_id",),
]
```

---

### 4.2 ç´¢å¼•æ±‡æ€»

```python
# app/models/task.py
class RenderTask(Model):
    class Meta:
        indexes = [
            ("unionid", "created_at"),           # ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
            ("status", "priority", "created_at"), # ä»»åŠ¡é˜Ÿåˆ—
            ("scene_file_hash",),                # åœºæ™¯å»é‡
            ("hardware_config_id",),             # ç¡¬ä»¶åˆ†é…
        ]

# app/models/frame.py
class RenderFrame(Model):
    class Meta:
        indexes = [
            ("task_id", "frame_number"),  # ä»»åŠ¡å¸§åˆ—è¡¨
            ("task_id", "status"),        # ä»»åŠ¡è¿›åº¦ç»Ÿè®¡
        ]

# app/models/asset.py
class Asset(Model):
    class Meta:
        indexes = [
            # file_hash å·²ç»æ˜¯ unique,è‡ªåŠ¨ç´¢å¼•
            ("file_xxhash",),             # å¿«é€Ÿæ ¡éªŒ
            ("uploaded_by", "uploaded_at"), # ç”¨æˆ·ä¸Šä¼ å†å²
        ]

# app/models/task_asset.py
class TaskAsset(Model):
    class Meta:
        indexes = [
            ("task_id",),
            ("asset_id",),
        ]
        unique_together = [("task_id", "asset_id")]
```

---

## 5. æ•°æ®è¿ç§»æ–¹æ¡ˆ

### 5.1 ä½¿ç”¨ Aerich è¿›è¡Œè¿ç§»

Tortoise ORM å®˜æ–¹æ¨èä½¿ç”¨ **Aerich** è¿›è¡Œæ•°æ®åº“è¿ç§»ã€‚

#### å®‰è£… Aerich

```bash
pip install aerich
```

#### åˆå§‹åŒ– Aerich

```bash
aerich init -t app.config.TORTOISE_ORM
aerich init-db
```

#### åˆ›å»ºè¿ç§»æ–‡ä»¶

æ¯æ¬¡ä¿®æ”¹æ¨¡å‹å:

```bash
aerich migrate --name "add_test_frame_fields"
```

#### åº”ç”¨è¿ç§»

```bash
aerich upgrade
```

#### å›æ»šè¿ç§»

```bash
aerich downgrade
```

---

### 5.2 è¿ç§»æ­¥éª¤

#### é˜¶æ®µ 1: æ·»åŠ æµ‹è¯•å¸§å­—æ®µ

**è¿ç§»æ–‡ä»¶**: `migrations/001_add_test_frame_fields.py`

```python
# æ·»åŠ å­—æ®µ
ALTER TABLE render_tasks ADD COLUMN test_frames VARCHAR(100);
ALTER TABLE render_tasks ADD COLUMN stop_after_test BOOLEAN DEFAULT FALSE;
ALTER TABLE render_frames ADD COLUMN is_test_frame BOOLEAN DEFAULT FALSE;
```

**éªŒè¯**:
```python
task = await RenderTask.create(
    unionid="user123",
    oss_file_path="test.ma",
    render_engine=RenderEngine.MAYA,
    test_frames="50",
    stop_after_test=True
)
assert task.test_frames == "50"
```

---

#### é˜¶æ®µ 2: æ·»åŠ ç¡¬ä»¶éœ€æ±‚å­—æ®µ

**è¿ç§»æ–‡ä»¶**: `migrations/002_add_hardware_fields.py`

```python
# åˆ›å»º hardware_configs è¡¨
CREATE TABLE hardware_configs (
    id VARCHAR(20) PRIMARY KEY,
    config_name VARCHAR(100) NOT NULL,
    ram INTEGER NOT NULL,
    cpu_cores INTEGER,
    gpu_count INTEGER DEFAULT 0,
    gpu_model VARCHAR(100),
    price_per_hour DECIMAL(10, 4),
    is_available BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

# æ·»åŠ å­—æ®µåˆ° render_tasks
ALTER TABLE render_tasks ADD COLUMN ram INTEGER;
ALTER TABLE render_tasks ADD COLUMN gpu_count INTEGER DEFAULT 0;
ALTER TABLE render_tasks ADD COLUMN hardware_config_id VARCHAR(20);

# æ’å…¥é»˜è®¤ç¡¬ä»¶é…ç½®
INSERT INTO hardware_configs (id, config_name, ram, cpu_cores, gpu_count)
VALUES ('basic', 'åŸºç¡€é…ç½®', 16, 8, 0);
```

---

#### é˜¶æ®µ 3: æ·»åŠ èµ„äº§ç®¡ç†è¡¨

**è¿ç§»æ–‡ä»¶**: `migrations/003_add_asset_tables.py`

```python
# åˆ›å»º assets è¡¨
CREATE TABLE assets (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    file_path VARCHAR(500) NOT NULL,
    file_hash VARCHAR(64) UNIQUE NOT NULL,
    file_xxhash VARCHAR(20),
    file_size BIGINT NOT NULL,
    file_type VARCHAR(20) DEFAULT 'other',
    storage_path VARCHAR(500) NOT NULL,
    uploaded_by VARCHAR(100),
    reference_count INTEGER DEFAULT 0,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP
);

CREATE INDEX idx_assets_hash ON assets(file_hash);
CREATE INDEX idx_assets_xxhash ON assets(file_xxhash);

# åˆ›å»º task_assets è¡¨
CREATE TABLE task_assets (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id INTEGER NOT NULL,
    asset_id BIGINT NOT NULL,
    local_path VARCHAR(500) NOT NULL,
    server_path VARCHAR(500) NOT NULL,
    is_missing BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES render_tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (asset_id) REFERENCES assets(id),
    UNIQUE (task_id, asset_id)
);

CREATE INDEX idx_task_assets_task ON task_assets(task_id);
CREATE INDEX idx_task_assets_asset ON task_assets(asset_id);
```

---

## 6. æŸ¥è¯¢ç¤ºä¾‹

### 6.1 è·å–ä»»åŠ¡è¯¦æƒ… (åŒ…å«å¸§ä¿¡æ¯)

```python
from tortoise.query_utils import Prefetch

task = await RenderTask.get(id=123).prefetch_related(
    Prefetch("frames", queryset=RenderFrame.all().order_by("frame_number"))
)

print(f"ä»»åŠ¡ {task.id}: {task.status}")
print(f"æ€»å¸§æ•°: {len(task.frames)}")
print(f"å·²å®Œæˆ: {sum(1 for f in task.frames if f.status == FrameStatus.COMPLETED)}")
```

---

### 6.2 è·å–ä»»åŠ¡çš„æ‰€æœ‰èµ„äº§

```python
task = await RenderTask.get(id=123).prefetch_related("task_assets__asset")

for ta in task.task_assets:
    asset = ta.asset
    print(f"èµ„äº§: {asset.file_path} (hash: {asset.file_hash})")
    print(f"  æœ¬åœ°: {ta.local_path}")
    print(f"  æœåŠ¡å™¨: {ta.server_path}")
    if ta.is_missing:
        print(f"  âš ï¸ ç¼ºå¤±")
```

---

### 6.3 æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ (å»é‡)

```python
file_hash = "6e57efc1fb88700dfc4820e160348f07"

existing = await Asset.filter(file_hash=file_hash).first()

if existing:
    print(f"æ–‡ä»¶å·²å­˜åœ¨,è·³è¿‡ä¸Šä¼ ")
    print(f"å­˜å‚¨è·¯å¾„: {existing.storage_path}")
else:
    print(f"æ–‡ä»¶ä¸å­˜åœ¨,éœ€è¦ä¸Šä¼ ")
```

---

### 6.4 ç»Ÿè®¡ä»»åŠ¡è¿›åº¦

```python
task = await RenderTask.get(id=123).prefetch_related("frames")

total = len(task.frames)
completed = sum(1 for f in task.frames if f.status == FrameStatus.COMPLETED)
failed = sum(1 for f in task.frames if f.status == FrameStatus.FAILED)
rendering = sum(1 for f in task.frames if f.status == FrameStatus.RENDERING)

progress = (completed / total) * 100 if total > 0 else 0

# æ›´æ–°ä»»åŠ¡è¿›åº¦
task.progress = round(progress, 2)
task.completed_frames_count = completed
task.failed_frames_count = failed
await task.save()

print(f"è¿›åº¦: {progress:.2f}%")
print(f"å®Œæˆ: {completed}/{total}")
print(f"å¤±è´¥: {failed}")
print(f"æ¸²æŸ“ä¸­: {rendering}")
```

---

### 6.5 è·å–ç¡¬ä»¶é…ç½®

```python
# è·å–æ‰€æœ‰å¯ç”¨é…ç½®
configs = await HardwareConfig.filter(is_available=True).all()

for config in configs:
    print(f"{config.config_name}:")
    print(f"  RAM: {config.ram}GB")
    print(f"  GPU: {config.gpu_count}x {config.gpu_model or 'CPU'}")
    print(f"  ä»·æ ¼: {config.price_per_hour}å…ƒ/å°æ—¶")

# æŸ¥æ‰¾æ»¡è¶³éœ€æ±‚çš„é…ç½®
required_ram = 64
required_gpu = 2

suitable = await HardwareConfig.filter(
    ram__gte=required_ram,
    gpu_count__gte=required_gpu,
    is_available=True
).order_by("price_per_hour").first()

if suitable:
    print(f"æ¨èé…ç½®: {suitable.config_name}")
else:
    print(f"æ— å¯ç”¨é…ç½®æ»¡è¶³éœ€æ±‚")
```

---

## 7. æ•°æ®åº“ä¼˜åŒ–å»ºè®®

### 7.1 å®šæœŸæ¸…ç†

```python
import datetime

async def cleanup_old_data():
    """æ¸…ç†æ—§æ•°æ®"""

    # 1. æ¸…ç† 30 å¤©å‰å·²å®Œæˆçš„ä»»åŠ¡
    cutoff_date = datetime.datetime.now() - datetime.timedelta(days=30)

    old_tasks = await RenderTask.filter(
        status=TaskStatus.COMPLETED,
        completed_at__lt=cutoff_date
    ).all()

    for task in old_tasks:
        # åˆ é™¤å·¥ä½œç©ºé—´
        if task.workspace_dir and os.path.exists(task.workspace_dir):
            shutil.rmtree(task.workspace_dir)

        # åˆ é™¤æ•°æ®åº“è®°å½• (çº§è”åˆ é™¤å¸§è®°å½•)
        await task.delete()

    # 2. æ¸…ç†æœªè¢«å¼•ç”¨çš„èµ„äº§
    unused_assets = await Asset.filter(reference_count=0).all()

    for asset in unused_assets:
        # ä» OSS åˆ é™¤
        await oss_storage.delete(asset.storage_path)

        # ä»æ•°æ®åº“åˆ é™¤
        await asset.delete()
```

---

### 7.2 å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯

```python
async def update_task_statistics(task_id: int):
    """æ›´æ–°ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯"""

    task = await RenderTask.get(id=task_id).prefetch_related("frames")

    total = len(task.frames)
    completed = sum(1 for f in task.frames if f.status == FrameStatus.COMPLETED)
    failed = sum(1 for f in task.frames if f.status == FrameStatus.FAILED)

    task.completed_frames_count = completed
    task.failed_frames_count = failed
    task.progress = round((completed / total) * 100, 2) if total > 0 else 0

    # è®¡ç®—å®é™…æˆæœ¬
    if task.hardware_config_id:
        config = await HardwareConfig.get(id=task.hardware_config_id)
        total_render_time = sum(
            (f.render_time or 0) for f in task.frames if f.render_time
        )
        task.actual_cost = round(
            (total_render_time / 3600) * float(config.price_per_hour),
            2
        )

    await task.save()
```

---

## 8. é…ç½® Tortoise ORM

### 8.1 æ›´æ–°é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `app/config.py`

```python
TORTOISE_ORM = {
    "connections": {
        "default": os.getenv("DATABASE_URL", "sqlite://db.sqlite3")
    },
    "apps": {
        "models": {
            "models": [
                "app.models.task",
                "app.models.frame",
                "app.models.user",          # æ–°å¢
                "app.models.asset",         # æ–°å¢
                "app.models.task_asset",    # æ–°å¢
                "app.models.hardware",      # æ–°å¢
                "app.models.scene_analysis", # æ–°å¢
                "aerich.models"             # Aerich è¿ç§»ç®¡ç†
            ],
            "default_connection": "default",
        }
    }
}
```

---

## 9. æ€»ç»“

### 9.1 æ–°å¢è¡¨

âœ… `users` - ç”¨æˆ·ç®¡ç†
âœ… `assets` - èµ„äº§å»é‡
âœ… `task_assets` - ä»»åŠ¡èµ„äº§å…³è”
âœ… `hardware_configs` - ç¡¬ä»¶é…ç½®
âœ… `scene_analyses` - åœºæ™¯åˆ†æç¼“å­˜

### 9.2 æ‰©å±•å­—æ®µ

âœ… `RenderTask` - æµ‹è¯•å¸§ã€ç¡¬ä»¶éœ€æ±‚ã€æ–‡ä»¶å“ˆå¸Œã€è¿›åº¦ç»Ÿè®¡
âœ… `RenderFrame` - èŠ‚ç‚¹ä¿¡æ¯ã€è¾“å‡ºä¿¡æ¯ã€æ€§èƒ½ç»Ÿè®¡

### 9.3 ç´¢å¼•ä¼˜åŒ–

âœ… å¤åˆç´¢å¼• - ä¼˜åŒ–å¤šæ¡ä»¶æŸ¥è¯¢
âœ… å”¯ä¸€ç´¢å¼• - æ–‡ä»¶å»é‡
âœ… å¤–é”®ç´¢å¼• - å…³è”æŸ¥è¯¢åŠ é€Ÿ

### 9.4 è¿ç§»ç­–ç•¥

âœ… ä½¿ç”¨ Aerich ç®¡ç†è¿ç§»
âœ… åˆ†é˜¶æ®µè¿ç§»,é™ä½é£é™©
âœ… å‘åå…¼å®¹,ä¸ç ´åç°æœ‰æ•°æ®

---

## é™„å½•

### A. å®Œæ•´ SQL Schema

è¯¦è§: `docs/schema.sql` (å¦‚éœ€è¦å¯ç”Ÿæˆ)

### B. æµ‹è¯•æ•°æ®

è¯¦è§: `docs/test_data.sql` (å¦‚éœ€è¦å¯ç”Ÿæˆ)

### C. æ€§èƒ½æµ‹è¯•

è¯¦è§: `docs/performance_test.md` (å¦‚éœ€è¦å¯ç”Ÿæˆ)

ä¸‹ä¸€æ­¥: æŸ¥çœ‹ [APIæ¥å£è®¾è®¡.md](./APIæ¥å£è®¾è®¡.md)
