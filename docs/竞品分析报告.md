# ç«å“æ¸²æŸ“æœåŠ¡æ¥å£åˆ†ææŠ¥å‘Š

> åŸºäºæŠ“åŒ…æ•°æ®åæ¨ç«å“ç³»ç»Ÿè®¾è®¡
> åˆ†ææ—¥æœŸ: 2025-11-04
> æ•°æ®æ¥æº: json_files/ ç›®å½•ä¸‹çš„ API æŠ“åŒ…æ–‡ä»¶

---

## 1. æ¦‚è¿°

### 1.1 æ–‡ä»¶æ¸…å•

| æ–‡ä»¶å | å¤§å° | åŠŸèƒ½æ¨æ–­ |
|--------|------|----------|
| **asset.json** | 30.8KB | åœºæ™¯èµ„äº§ä¾èµ–åˆ†æç»“æœ |
| **upload.json** | 9.4KB | æ–‡ä»¶ä¸Šä¼ è·¯å¾„æ˜ å°„è¡¨ |
| **task.json** | 12.2KB | å®Œæ•´çš„æ¸²æŸ“ä»»åŠ¡é…ç½® |
| **create_task_examples.json** | - | API è°ƒç”¨ç¤ºä¾‹æ–‡æ¡£ |

### 1.2 æ ¸å¿ƒå‘ç°

é€šè¿‡åˆ†æè¿™äº› JSON æ–‡ä»¶ï¼Œå¯ä»¥æ¨æ–­å‡ºç«å“ç³»ç»Ÿå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

âœ… **æ™ºèƒ½åœºæ™¯åˆ†æ** - è‡ªåŠ¨æå–åœºæ™¯ä¾èµ–ï¼Œè¯†åˆ«ç¼ºå¤±æ–‡ä»¶
âœ… **å¢é‡æ–‡ä»¶ä¼ è¾“** - åŸºäº hash å»é‡ï¼Œé¿å…é‡å¤ä¸Šä¼ 
âœ… **ç²¾ç»†ç¡¬ä»¶è°ƒåº¦** - æ ¹æ® RAM/GPU éœ€æ±‚åŒ¹é…æ¸²æŸ“èŠ‚ç‚¹
âœ… **æµ‹è¯•å¸§æœºåˆ¶** - å…ˆæ¸²æŸ“æŒ‡å®šå¸§éªŒè¯ï¼Œé€šè¿‡åç»§ç»­
âœ… **è·¨å¹³å°è·¯å¾„æ˜ å°„** - Windows â†’ Linux è‡ªåŠ¨è½¬æ¢
âœ… **å®Œæ•´æ€§æ ¡éªŒ** - MD5 + xxHash åŒé‡éªŒè¯

---

## 2. å­—æ®µåˆ†ç±»åˆ†æ

### 2.1 ä» MB æ–‡ä»¶è¯»å–çš„å‚æ•°

è¿™äº›å‚æ•°é€šè¿‡è§£æ Maya åœºæ™¯æ–‡ä»¶è·å¾—ï¼Œå®¢æˆ·ç«¯éœ€è¦å®ç°åœºæ™¯åˆ†æåŠŸèƒ½ã€‚

#### ğŸ“¦ åœºæ™¯åŸºæœ¬ä¿¡æ¯

```json
{
  "scene_file": "C:/Project/.../wolf_fur_refV33.ma",
  "scene_file_size": 841968626,  // çº¦ 800MB
  "asset_num": 33,                // ä¾èµ–æ–‡ä»¶æ•°é‡
  "asset_size": 23748328          // ä¾èµ–æ–‡ä»¶æ€»å¤§å° (çº¦ 23MB)
}
```

#### ğŸ¬ æ¸²æŸ“èŒƒå›´

```json
{
  "animation": "True",
  "start": "1",
  "end": "3",
  "by_frame": "1",               // æ­¥é•¿
  "frames": "1-3[1]"             // å¸§èŒƒå›´è¡¨è¾¾å¼: start-end[step]
}
```

#### ğŸ“· æ‘„åƒæœºè®¾ç½®

```json
{
  "all_camera": [
    "cameraShape1", "perspShape", "frontShape", "topShape", ...
  ],
  "render_camera": ["cameraShape1"],  // å½“å‰æ¸²æŸ“ç›¸æœº
  "is_default_camera": "1"
}
```

#### ğŸ–¼ï¸ è¾“å‡ºè®¾ç½®

```json
{
  "width": "2048",
  "height": "1152",
  "image_format": "exr",
  "image_file_prefix": "wolf_v32/wolf_v32",  // è¾“å‡ºè·¯å¾„å‰ç¼€
  "renumber_frames": "False"
}
```

#### ğŸ¨ æ¸²æŸ“å™¨é…ç½®

```json
{
  "renderer": "arnold",
  "sampling": ["7", "5", "5", "3", "3", "2"],
  // [Camera AA, Diffuse, Specular, SSS, Transmission, Volume]

  "motion_blur_enable": "False",
  "auto_tx": "False",                          // è´´å›¾è½¬ .tx æ ¼å¼
  "tiled": "True",                             // åˆ†å—è´´å›¾
  "threads_autodetect": "True",
  "textureMaxMemoryMB": "4096.0"
}
```

#### ğŸ—‚ï¸ èµ„äº§ä¾èµ–åˆ—è¡¨

```json
{
  "asset": [
    "C:/Program Files/Autodesk/Maya2022/resources/OCIO-configs/Maya-legacy/config.ocio (mtime 2021-01-23 05:39:53) size 10429",
    "Y:/Render_Test/.../wolf_fur_v02.xgen (mtime 2024-10-17 20:56:32) size 11925",
    // ... åŒ…å«ä¿®æ”¹æ—¶é—´å’Œæ–‡ä»¶å¤§å°
  ]
}
```

**å…³é”®å‘ç°**ï¼š
- åŒ…å«å¤§é‡ OCIO (è‰²å½©ç®¡ç†) é…ç½®æ–‡ä»¶
- ä½¿ç”¨ XGen æ¯›å‘ç³»ç»Ÿï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
- èµ„äº§è·¯å¾„è·¨è¶Šå¤šä¸ªç›˜ç¬¦ï¼ˆY:/, D:/, C:/ï¼‰

#### âš ï¸ ç¼ºå¤±èµ„äº§

```json
{
  "missing": [
    {
      "wolf_fur_refV33__wolf_fur_v02.xgen_xgen_project_xgen_procedural":
        "Y:/Render_Test/Arnold/wolf_xgen/Wolf/xgen"
    },
    {
      "file1.computedFileTextureNamePattern":
        "Y:/Render_Test/.../sourceimages/${PROJECT}/${DESC}..."
    }
  ]
}
```

**ç¼ºå¤±åŸå› **ï¼š
- Maya å˜é‡æœªå±•å¼€ï¼ˆ`${PROJECT}`, `${DESC}`, `${FXMODULE}`ï¼‰
- XGen ç‰¹å®šè·¯å¾„å¼•ç”¨
- è·¨æœºå™¨è¿ç§»å¯¼è‡´ç›˜ç¬¦ä¸åŒ¹é…

---

### 2.2 æœåŠ¡å™¨ç«¯ç”Ÿæˆçš„å‚æ•°

è¿™äº›å‚æ•°ç”±åç«¯ç³»ç»Ÿç”Ÿæˆå’Œç®¡ç†ã€‚

#### ğŸ‘¤ ç”¨æˆ·èº«ä»½ä¿¡æ¯

```json
{
  "user_id": 101044736,
  "user_name": "Shengshu",
  "account_type": 1,              // 1=ä¸ªäºº, 2=ä¼ä¸š
  "parent_id": 0,                 // å­è´¦æˆ·çš„ä¸»è´¦æˆ·ID
  "shareMainCapital": false,      // æ˜¯å¦å…±äº«ä¸»è´¦æˆ·ä½™é¢
  "zone": 1                       // 1=å›½å†…, 2=æµ·å¤–
}
```

#### ğŸ†” ä»»åŠ¡æ ‡è¯†

```json
{
  "task_id": "219682760",         // 9ä½æ•°å­—ID
  "job_id": "219682760",          // ä»»åŠ¡ç»„ID
  "job_id_alias": "1G219682760",  // å¸¦å‰ç¼€çš„åˆ«å
  "project_id": 1341572,
  "project_name": "default"
}
```

#### ğŸ–¥ï¸ ç¡¬ä»¶éœ€æ±‚

```json
{
  "ram": "64",                    // 64GB å†…å­˜
  "graphics_cards_num": "2",      // 2 å—æ˜¾å¡
  "hardwareConfigIds": ["418"],   // ç¡¬ä»¶é…ç½®ID (å¯¹åº”å…·ä½“æœºå‹)
  "gpu_render": 0,                // 0=CPUæ¸²æŸ“, 1=GPUæ¸²æŸ“
  "platform": "21"                // å¹³å°æ ‡è¯†
}
```

#### ğŸ“Š ä»»åŠ¡åˆ†é…ç­–ç•¥

```json
{
  "frames_per_task": "1",         // æ¯ä¸ªæ¸²æŸ“èŠ‚ç‚¹æ¸²æŸ“ 1 å¸§
  "tiles": "1",                   // åˆ†å—æ•°é‡
  "tiles_type": "strip",          // åˆ†å—ç±»å‹: strip(æ¡çŠ¶) / block(ç½‘æ ¼)
  "distribute_node": "1",         // åˆ†å¸ƒå¼èŠ‚ç‚¹æ•°
  "is_distribute_render": "0"     // æ˜¯å¦å¯ç”¨åˆ†å¸ƒå¼æ¸²æŸ“
}
```

#### ğŸ§ª æµ‹è¯•å¸§é…ç½®

```json
{
  "pre_frames": "100",            // é¢„æ¸²æŸ“å¸§å· (æµ‹è¯•å¸§)
  "stop_after_test": "1",         // æµ‹è¯•å¸§å®Œæˆåæ˜¯å¦åœæ­¢
  "test_frames": "100"
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. ä»»åŠ¡åˆ›å»ºæ—¶æŒ‡å®š `test_frames: "100"`
2. ç³»ç»Ÿå…ˆæ¸²æŸ“ç¬¬ 100 å¸§
3. å¦‚æœæˆåŠŸ â†’ ç»§ç»­æ¸²æŸ“å…¶ä»–å¸§
4. å¦‚æœå¤±è´¥ä¸” `stop_after_test: 1` â†’ ç«‹å³åœæ­¢ä»»åŠ¡
5. ç”¨æˆ·ä¸‹è½½æµ‹è¯•å¸§æ£€æŸ¥æ•ˆæœåå†³å®šæ˜¯å¦ç»§ç»­

#### â±ï¸ è¶…æ—¶æ§åˆ¶

```json
{
  "time_out": "43200",            // å•å¸§è¶…æ—¶: 12å°æ—¶
  "task_stop_time": "0",
  "job_stop_time": "86400"        // ä»»åŠ¡æ€»è¶…æ—¶: 24å°æ—¶
}
```

#### ğŸ’» å®¢æˆ·ç«¯ç¯å¢ƒä¿¡æ¯

```json
{
  "client": "Renderbus",
  "version": "5.2.2.4",
  "build": "Build 2025-08-25",
  "client_cmd": "rendercmd.exe",
  "os": "Windows 10(10.0.17763)",
  "ip": "192.168.99.106",
  "mac": "04:42:1A:ED:CA:D9",
  "system_locale": "zh_CN",
  "date_time": "2025-10-18 22:11:11"
}
```

#### ğŸ“¦ è½¯ä»¶é…ç½®

```json
{
  "cg_id": 2000,                  // 2000=Maya, 2001=3ds Max, ...
  "cg_name": "Maya",
  "cg_version": "2024",
  "os_name": 1,                   // 1=Windows, 2=Linux
  "software_config": {
    "cg_inst_dir": "C:/Program Files/Autodesk/Maya2022/bin",
    "plugins": {
      "mtoa": "5.5.1"             // Maya To Arnold æ’ä»¶ç‰ˆæœ¬
    }
  }
}
```

---

### 2.3 æ–‡ä»¶ä¸Šä¼ æ˜ å°„ (upload.json)

#### ğŸ” æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ

```json
{
  "scene": [
    {
      "local": "C:/Project/.../wolf_fur_refV33.ma",
      "server": "/C/Project/.../wolf_fur_refV33.ma",
      "hash": "6e57efc1fb88700dfc4820e160348f07",     // MD5
      "xxhash": "7021565326244519815"                 // xxHash (æ›´å¿«)
    }
  ],
  "asset": [
    {
      "local": "C:/Program Files/Autodesk/Maya2022/resources/...",
      "server": "/C/Program Files/Autodesk/Maya2022/resources/..."
    }
  ]
}
```

**è·¯å¾„è½¬æ¢è§„åˆ™**:
- Windows: `C:/Project/...` â†’ Linux: `/C/Project/...`
- ä¿ç•™åŸå§‹ç›®å½•ç»“æ„

**åŒé‡å“ˆå¸Œä½œç”¨**:
- **MD5**: ç”¨äºæ–‡ä»¶å»é‡ï¼ˆå·²å­˜åœ¨åˆ™è·³è¿‡ä¸Šä¼ ï¼‰
- **xxHash**: ç”¨äºå¿«é€Ÿå®Œæ•´æ€§æ ¡éªŒï¼ˆä¼ è¾“åéªŒè¯ï¼‰

---

## 3. æ¥å£è®¾è®¡æ¨æ–­

### 3.1 API ç«¯ç‚¹æ˜ å°„

| ç«¯ç‚¹ | æ–¹æ³• | å¯¹åº”æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|----------|------|
| `/api/scene/analyse` | POST | asset.json | ä¸Šä¼ åœºæ™¯ï¼Œåˆ†æèµ„äº§ä¾èµ– |
| `/api/scene/upload` | POST | upload.json | ç”Ÿæˆä¸Šä¼ æ¸…å•å’Œè·¯å¾„æ˜ å°„ |
| `/api/task/create` | POST | task.json | åˆ›å»ºæ¸²æŸ“ä»»åŠ¡ |
| `/api/task/{id}/status` | GET | - | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦ |
| `/api/task/{id}/frames` | GET | - | è·å–å¸§æ¸²æŸ“è¯¦æƒ… |
| `/api/files/download` | GET | - | ä¸‹è½½æ¸²æŸ“ç»“æœ |

### 3.2 å®Œæ•´å·¥ä½œæµç¨‹

```
[å®¢æˆ·ç«¯] ç”¨æˆ·é€‰æ‹© Maya åœºæ™¯æ–‡ä»¶
   â†“
1ï¸âƒ£ POST /api/scene/analyse
   Body: { scene_file: "C:/Project/wolf.ma" }
   â†“
   Response: asset.json (èµ„äº§æ¸…å• + ç¼ºå¤±æ–‡ä»¶åˆ—è¡¨)
   â†“
[å®¢æˆ·ç«¯] æ˜¾ç¤ºç¼ºå¤±æ–‡ä»¶ï¼Œç”¨æˆ·å¤„ç† (ä¿®å¤è·¯å¾„/å¿½ç•¥)
   â†“
2ï¸âƒ£ POST /api/scene/upload
   Body: {
     files: [{local, hash, xxhash}, ...],
     scene_hash: "6e57efc1..."
   }
   â†“
   Response: upload.json (local â†’ server è·¯å¾„æ˜ å°„)
   â†“
[å®¢æˆ·ç«¯] ä½¿ç”¨ä¼ è¾“å¼•æ“ä¸Šä¼ æ–‡ä»¶ (å¢é‡ä¸Šä¼ )
   â†“
3ï¸âƒ£ POST /api/task/create
   Body: task.json (å®Œæ•´é…ç½®)
   â†“
   Response: { task_id: "219682760", status: "queued" }
   â†“
[æœåŠ¡å™¨] è‡ªåŠ¨æ‰§è¡Œæ¸²æŸ“æµç¨‹
   - åˆ†é…æ¸²æŸ“èŠ‚ç‚¹
   - è·¯å¾„é‡æ˜ å°„
   - æ¸²æŸ“æµ‹è¯•å¸§ (pre_frames)
   - æ¸²æŸ“å…¶ä»–å¸§
   â†“
4ï¸âƒ£ GET /api/task/{id}/status (è½®è¯¢)
   Response: {
     status: "rendering",
     progress: 45.5,
     completed_frames: [1, 2, 100],
     failed_frames: []
   }
   â†“
5ï¸âƒ£ GET /api/files/download?frame=1
   ä¸‹è½½æ¸²æŸ“ç»“æœ
```

---

## 4. æ•°æ®åº“è®¾è®¡æ¨æ–­

### 4.1 æ ¸å¿ƒè¡¨ç»“æ„

#### users è¡¨

```sql
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,
    user_name VARCHAR(100) NOT NULL,
    account_type TINYINT NOT NULL,        -- 1=ä¸ªäºº, 2=ä¼ä¸š
    parent_id BIGINT DEFAULT 0,           -- ä¸»è´¦æˆ·ID
    share_main_capital BOOLEAN DEFAULT FALSE,
    zone TINYINT NOT NULL,                -- 1=å›½å†…, 2=æµ·å¤–
    balance DECIMAL(10, 2) DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### tasks è¡¨ (æ‰©å±•ç‰ˆ)

```sql
CREATE TABLE tasks (
    task_id VARCHAR(20) PRIMARY KEY,
    job_id VARCHAR(20) NOT NULL,
    user_id BIGINT NOT NULL,

    -- åœºæ™¯ä¿¡æ¯
    scene_file_path VARCHAR(500),
    scene_file_size BIGINT,
    scene_file_hash VARCHAR(64),

    -- CG è½¯ä»¶
    cg_id SMALLINT NOT NULL,              -- 2000=Maya
    cg_version VARCHAR(20),
    renderer VARCHAR(50),                 -- "arnold"
    plugins JSON,

    -- æ¸²æŸ“é…ç½®
    frame_start INT NOT NULL,
    frame_end INT NOT NULL,
    frame_step INT DEFAULT 1,
    frames_per_task SMALLINT DEFAULT 1,
    test_frames VARCHAR(100),             -- "100" (æµ‹è¯•å¸§)

    -- ç¡¬ä»¶éœ€æ±‚
    ram SMALLINT NOT NULL,                -- 64 (GB)
    gpu_count SMALLINT DEFAULT 0,
    hardware_config_ids JSON,             -- ["418"]

    -- çŠ¶æ€
    status ENUM('queued', 'preparing', 'rendering',
                'paused', 'completed', 'failed', 'cancelled'),
    priority SMALLINT DEFAULT 5,
    progress DECIMAL(5, 2) DEFAULT 0.00,

    -- è¶…æ—¶æ§åˆ¶
    time_out INT DEFAULT 43200,           -- å•å¸§è¶…æ—¶ (ç§’)
    job_stop_time INT DEFAULT 86400,      -- ä»»åŠ¡è¶…æ—¶ (ç§’)

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,

    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

#### assets è¡¨ (èµ„äº§å»é‡)

```sql
CREATE TABLE assets (
    asset_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    file_path VARCHAR(500) NOT NULL,
    file_hash VARCHAR(64) NOT NULL,       -- MD5
    file_xxhash VARCHAR(20),              -- xxHash
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50),                -- "texture", "xgen", "plugin"
    storage_path VARCHAR(500),            -- æœåŠ¡å™¨å­˜å‚¨è·¯å¾„
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_hash (file_hash)
);
```

#### task_assets è¡¨ (ä»»åŠ¡-èµ„äº§å…³è”)

```sql
CREATE TABLE task_assets (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id VARCHAR(20) NOT NULL,
    asset_id BIGINT NOT NULL,
    local_path VARCHAR(500),              -- å®¢æˆ·ç«¯è·¯å¾„
    server_path VARCHAR(500),             -- æœåŠ¡å™¨è·¯å¾„
    is_missing BOOLEAN DEFAULT FALSE,

    FOREIGN KEY (task_id) REFERENCES tasks(task_id) ON DELETE CASCADE,
    FOREIGN KEY (asset_id) REFERENCES assets(asset_id)
);
```

#### hardware_configs è¡¨

```sql
CREATE TABLE hardware_configs (
    config_id VARCHAR(20) PRIMARY KEY,    -- "418"
    config_name VARCHAR(100),             -- "é«˜æ€§èƒ½æ¸²æŸ“èŠ‚ç‚¹"
    ram SMALLINT NOT NULL,
    cpu_cores SMALLINT,
    gpu_count SMALLINT,
    gpu_model VARCHAR(100),
    price_per_hour DECIMAL(10, 4)
);
```

---

## 5. å…³é”®æŠ€æœ¯å®ç°

### 5.1 åœºæ™¯åˆ†æå™¨

éœ€è¦ä½¿ç”¨ **Maya Python API** æˆ– **mayapy.exe** è§£æåœºæ™¯æ–‡ä»¶ï¼š

```python
import maya.standalone
maya.standalone.initialize()
import maya.cmds as cmds

def analyze_scene(scene_file):
    cmds.file(scene_file, open=True, force=True)

    # è·å–æ¸²æŸ“è®¾ç½®
    render_settings = {
        "renderer": cmds.getAttr("defaultRenderGlobals.currentRenderer"),
        "start": cmds.getAttr("defaultRenderGlobals.startFrame"),
        "end": cmds.getAttr("defaultRenderGlobals.endFrame"),
        "width": cmds.getAttr("defaultResolution.width"),
        "height": cmds.getAttr("defaultResolution.height"),
    }

    # è·å–æ‰€æœ‰æ–‡ä»¶ä¾èµ–
    file_nodes = cmds.ls(type="file")
    textures = []
    for node in file_nodes:
        file_path = cmds.getAttr(f"{node}.fileTextureName")
        textures.append(file_path)

    # æ£€æŸ¥ç¼ºå¤±æ–‡ä»¶
    missing = [f for f in textures if not os.path.exists(f)]

    return {
        "scene_info": render_settings,
        "asset": textures,
        "missing": missing
    }
```

### 5.2 æ–‡ä»¶å“ˆå¸Œè®¡ç®—

```python
import hashlib
import xxhash

def compute_hashes(file_path):
    md5 = hashlib.md5()
    xxh = xxhash.xxh64()

    with open(file_path, "rb") as f:
        while chunk := f.read(8192):
            md5.update(chunk)
            xxh.update(chunk)

    return {
        "hash": md5.hexdigest(),
        "xxhash": str(xxh.intdigest())
    }
```

### 5.3 å¢é‡ä¸Šä¼ é€»è¾‘

```python
async def upload_assets(assets: List[dict]):
    # 1. è®¡ç®—æ‰€æœ‰æ–‡ä»¶çš„ hash
    hashes = [compute_hashes(a["local"])["hash"] for a in assets]

    # 2. æŸ¥è¯¢æœåŠ¡å™¨å·²å­˜åœ¨çš„æ–‡ä»¶
    existing = await db.query(
        "SELECT file_hash FROM assets WHERE file_hash IN %s",
        (tuple(hashes),)
    )
    existing_hashes = {row["file_hash"] for row in existing}

    # 3. åªä¸Šä¼ ä¸å­˜åœ¨çš„æ–‡ä»¶
    to_upload = [
        a for a in assets
        if compute_hashes(a["local"])["hash"] not in existing_hashes
    ]

    # 4. ä¸Šä¼ åˆ° OSS
    for asset in to_upload:
        await oss_storage.upload(asset["local"], asset["server"])
```

### 5.4 æµ‹è¯•å¸§æœºåˆ¶

```python
async def render_task_with_test_frame(task_id: str):
    task = await RenderTask.get(id=task_id)

    # 1. å…ˆæ¸²æŸ“æµ‹è¯•å¸§
    test_frame_num = int(task.task_info.get("test_frames", "1"))
    test_frame = await RenderFrame.filter(
        task_id=task_id,
        frame_number=test_frame_num
    ).first()

    # 2. æ¸²æŸ“æµ‹è¯•å¸§
    result = await render_frame(test_frame)

    # 3. æ£€æŸ¥æ˜¯å¦éœ€è¦åœæ­¢
    if result.status == "failed" and task.task_info.get("stop_after_test") == "1":
        await task.update(status=TaskStatus.FAILED)
        return

    # 4. æµ‹è¯•å¸§æˆåŠŸï¼Œç»§ç»­æ¸²æŸ“å…¶ä»–å¸§
    other_frames = await RenderFrame.filter(
        task_id=task_id
    ).exclude(frame_number=test_frame_num)

    for frame in other_frames:
        await render_frame(frame)
```

---

## 6. ä¸å½“å‰ç³»ç»Ÿçš„å·®å¼‚å¯¹æ¯”

| åŠŸèƒ½ | ç«å“ | å½“å‰ç³»ç»Ÿ | å»ºè®® |
|------|------|----------|------|
| **åœºæ™¯åˆ†æ** | âœ… è‡ªåŠ¨æå–ä¾èµ– | âŒ æ—  | ğŸ”§ æ–°å¢åœºæ™¯åˆ†ææœåŠ¡ |
| **æ–‡ä»¶æ ¡éªŒ** | âœ… MD5 + xxHash | âŒ æ—  | ğŸ”§ å¢åŠ åŒé‡æ ¡éªŒ |
| **å¢é‡ä¸Šä¼ ** | âœ… åŸºäº hash å»é‡ | âŒ å…¨é‡ä¸Šä¼  | ğŸ”§ å®ç°å¢é‡ç®—æ³• |
| **æµ‹è¯•å¸§** | âœ… å…ˆæ¸²æŸ“æµ‹è¯•å¸§ | âŒ æ—  | ğŸ”§ ä¼˜å…ˆçº§ P0 |
| **ç¡¬ä»¶åŒ¹é…** | âœ… RAM/GPU ç²¾ç¡®åŒ¹é… | âš ï¸ ç®€å•é˜Ÿåˆ— | ğŸ”§ æ‰©å±• tasks è¡¨ |
| **è·¯å¾„æ˜ å°„** | âœ… Windows â†’ Linux | âš ï¸ çº¯ Windows | âœ… ä¸éœ€è¦ |
| **åˆ†å—æ¸²æŸ“** | âœ… Tiles åˆ‡åˆ† | âŒ ä»…é€å¸§ | â¸ï¸ å¯é€‰åŠŸèƒ½ |
| **ä»»åŠ¡æš‚åœ** | âœ… æ”¯æŒ paused | âŒ ä»… cancelled | ğŸ”§ æ‰©å±•çŠ¶æ€æœº |
| **ä¸“æœ‰å®¢æˆ·ç«¯** | âœ… rendercmd.exe | âŒ æ—  | â¸ï¸ æš‚ä¸éœ€è¦ |

---

## 7. æ¨èæ”¹è¿›æ–¹æ¡ˆ

### ä¼˜å…ˆçº§ P0 (å¿…é¡»å®ç°)

1. **æµ‹è¯•å¸§æœºåˆ¶**
   - æ‰©å±• `RenderTask` æ¨¡å‹æ·»åŠ  `test_frames` å­—æ®µ
   - ä¿®æ”¹æ¸²æŸ“é€»è¾‘ï¼šå…ˆæ¸²æŸ“æµ‹è¯•å¸§ï¼ŒæˆåŠŸåç»§ç»­
   - æ·»åŠ  `stop_after_test` æ§åˆ¶

2. **æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ**
   - å®ç° MD5 å’Œ xxHash åŒé‡æ ¡éªŒ
   - ä¸Šä¼ å‰è®¡ç®— hashï¼Œå­˜å‚¨åˆ°æ•°æ®åº“
   - ä¸‹è½½åéªŒè¯ hash

3. **åŸºç¡€åœºæ™¯åˆ†æ**
   - ä½¿ç”¨ mayapy.exe è§£æåœºæ™¯æ–‡ä»¶
   - æå–åŸºæœ¬æ¸²æŸ“è®¾ç½®ï¼ˆåˆ†è¾¨ç‡ã€å¸§èŒƒå›´ã€ç›¸æœºï¼‰
   - åˆ—å‡ºè´´å›¾æ–‡ä»¶ä¾èµ–

### ä¼˜å…ˆçº§ P1 (é‡è¦åŠŸèƒ½)

4. **ç¡¬ä»¶éœ€æ±‚åŒ¹é…**
   - æ‰©å±• `tasks` è¡¨æ·»åŠ  `ram`, `gpu_count`, `hardware_config_ids`
   - åˆ›å»º `hardware_configs` è¡¨
   - å®ç°èµ„æºåˆ†é…ç®—æ³•

5. **å¢é‡ä¸Šä¼ ä¼˜åŒ–**
   - åˆ›å»º `assets` è¡¨å­˜å‚¨æ–‡ä»¶ hash
   - ä¸Šä¼ å‰æ£€æŸ¥ hash æ˜¯å¦å·²å­˜åœ¨
   - å¤ç”¨å·²ä¸Šä¼ çš„æ–‡ä»¶

6. **ä»»åŠ¡æš‚åœ/æ¢å¤**
   - æ‰©å±• TaskStatus æšä¸¾æ·»åŠ  `PAUSED`
   - å®ç°æš‚åœ API
   - å®ç°æ¢å¤ API

### ä¼˜å…ˆçº§ P2 (å¢å¼ºåŠŸèƒ½)

7. **å®Œæ•´åœºæ™¯åˆ†æ**
   - æå– Arnold é‡‡æ ·è®¾ç½®
   - è¯†åˆ« XGen æ¯›å‘ç³»ç»Ÿ
   - æ£€æµ‹ç¼ºå¤±æ–‡ä»¶å¹¶æä¾›ä¿®å¤å»ºè®®

8. **åˆ†å—æ¸²æŸ“**
   - æ”¯æŒå•å¸§åˆ†å—ï¼ˆtilesï¼‰
   - å®ç°å—åˆå¹¶é€»è¾‘
   - ç”¨äºè¶…å¤§åˆ†è¾¨ç‡æ¸²æŸ“

---

## 8. æ ¸å¿ƒæ•°æ®å­—å…¸

### CG è½¯ä»¶ ID æ˜ å°„

```python
CG_ID_MAP = {
    2000: "Maya",
    2001: "3ds Max",
    2004: "Houdini",
    2007: "Cinema 4D",
    2013: "Blender",
}
```

### ä»»åŠ¡çŠ¶æ€æµè½¬

```
queued â†’ preparing â†’ rendering â†’ completed
   â†“          â†“          â†“
cancelled  failed    paused â†’ rendering
                        â†“
                    cancelled
```

### ç¡¬ä»¶é…ç½®ç¤ºä¾‹

```python
HARDWARE_CONFIGS = {
    "418": {
        "name": "é«˜æ€§èƒ½æ¸²æŸ“èŠ‚ç‚¹",
        "ram": 64,      # GB
        "cpu_cores": 24,
        "gpu_count": 2,
        "gpu_model": "RTX 4090"
    },
    "419": {
        "name": "æ ‡å‡†æ¸²æŸ“èŠ‚ç‚¹",
        "ram": 32,
        "cpu_cores": 16,
        "gpu_count": 0
    }
}
```

---

## 9. æ€»ç»“

### ç«å“æ ¸å¿ƒä¼˜åŠ¿

1. **æ™ºèƒ½åŒ–** - è‡ªåŠ¨åœºæ™¯åˆ†æã€è·¯å¾„ä¿®å¤ã€å¢é‡ä¸Šä¼ 
2. **å¯é æ€§** - åŒé‡æ ¡éªŒã€æµ‹è¯•å¸§æœºåˆ¶ã€è¶…æ—¶æ§åˆ¶
3. **ç²¾ç»†åŒ–** - ç¡¬ä»¶ç²¾ç¡®åŒ¹é…ã€é€å¸§è¿½è¸ªã€åˆ†å—æ¸²æŸ“
4. **è·¨å¹³å°** - Windows å®¢æˆ·ç«¯ + Linux æ¸²æŸ“èŠ‚ç‚¹æ— ç¼å¯¹æ¥

### å½“å‰ç³»ç»Ÿä¼˜åŠ¿

1. **æ¶æ„æ¸…æ™°** - FastAPI + Celery + Tortoise ORM
2. **æ–‡ä»¶éš”ç¦»** - ç”¨æˆ·çº§å’Œä»»åŠ¡çº§åŒé‡éš”ç¦»
3. **OSS é›†æˆ** - å®Œå–„çš„äº‘å­˜å‚¨æ”¯æŒ
4. **å•å¸§é‡è¯•** - å¤±è´¥å¸§å¯ç‹¬ç«‹é‡è¯•

### æ”¹è¿›å»ºè®®

**çŸ­æœŸç›®æ ‡ï¼ˆ1-2å‘¨ï¼‰**:
- âœ… å®ç°æµ‹è¯•å¸§æœºåˆ¶
- âœ… æ·»åŠ æ–‡ä»¶ hash æ ¡éªŒ
- âœ… åŸºç¡€åœºæ™¯åˆ†æï¼ˆæå–æ¸²æŸ“è®¾ç½®ï¼‰

**ä¸­æœŸç›®æ ‡ï¼ˆ1ä¸ªæœˆï¼‰**:
- âœ… ç¡¬ä»¶éœ€æ±‚åŒ¹é…
- âœ… å¢é‡ä¸Šä¼ ä¼˜åŒ–
- âœ… ä»»åŠ¡æš‚åœ/æ¢å¤

**é•¿æœŸç›®æ ‡ï¼ˆ3ä¸ªæœˆï¼‰**:
- âœ… å®Œæ•´åœºæ™¯ä¾èµ–åˆ†æ
- âœ… è·¯å¾„è‡ªåŠ¨ä¿®å¤
- âœ… åˆ†å—æ¸²æŸ“æ”¯æŒ

---

## é™„å½•

### A. å‚è€ƒ JSON æ–‡ä»¶ä½ç½®

- `json_files/asset.json` - åœºæ™¯èµ„äº§åˆ†æ
- `json_files/upload.json` - æ–‡ä»¶ä¸Šä¼ æ˜ å°„
- `json_files/task.json` - ä»»åŠ¡é…ç½®
- `json_files/create_task_examples.json` - API ç¤ºä¾‹

### B. ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„è®¾è®¡.md](./ç³»ç»Ÿæ¶æ„è®¾è®¡.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md](./æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)
- [APIæ¥å£è®¾è®¡.md](./APIæ¥å£è®¾è®¡.md)
- [å®ç°æ­¥éª¤.md](./å®ç°æ­¥éª¤.md)
